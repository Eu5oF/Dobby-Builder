name: Build Dobby (Fixed NDK)

on:
  workflow_dispatch:

jobs:
  build-dobby:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Dobby Source
        uses: actions/checkout@v4
        with:
          repository: jmpews/Dobby
          submodules: recursive
          fetch-depth: 0

      - name: Download & Install NDK r27c (Manual)
        run: |
          echo "Downloading NDK r27c..."
          wget -q https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
          unzip -q android-ndk-r27c-linux.zip
          
          # Set Environment Variable for steps below
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r27c" >> $GITHUB_ENV
          
      - name: Build Dobby (Arm64 & Armv7)
        run: |
          # Create output directories
          mkdir -p output/arm64-v8a
          mkdir -p output/armeabi-v7a

          echo "--------------------------------------"
          echo "Building for ARM64-v8a (64-bit + 16KB)"
          echo "--------------------------------------"
          
          cmake -H. -Bbuild_64 \
            -DANDROID_NDK=$ANDROID_NDK_HOME \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI="arm64-v8a" \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DDOBBY_GENERATE_SHARED=OFF \
            -DCMAKE_CXX_FLAGS="-Wl,-z,max-page-size=16384" \
            -DCMAKE_C_FLAGS="-Wl,-z,max-page-size=16384"
            
          cmake --build build_64 --config Release
          cp build_64/libdobby.a output/arm64-v8a/libdobby.a

          echo "--------------------------------------"
          echo "Building for ARMEABI-v7a (32-bit)"
          echo "--------------------------------------"
          
          cmake -H. -Bbuild_32 \
            -DANDROID_NDK=$ANDROID_NDK_HOME \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI="armeabi-v7a" \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release \
            -DDOBBY_GENERATE_SHARED=OFF \
            -DCMAKE_CXX_FLAGS="-Wl,-z,max-page-size=16384" \
            -DCMAKE_C_FLAGS="-Wl,-z,max-page-size=16384"
            
          cmake --build build_32 --config Release
          cp build_32/libdobby.a output/armeabi-v7a/libdobby.a

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Dobby-Static-Libs-16KB
          path: output/
          

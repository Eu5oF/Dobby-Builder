name: Build Dobby r27 Fix
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: jmpews/Dobby
          submodules: recursive

      - name: Patch for NDK r27 & 16KB
        run: |
          # 1. Fix Assembly Syntax for Clang
          find . -name "*.asm" -type f -exec sed -i 's/@PAGE//g' {} +
          find . -name "*.asm" -type f -exec sed -i 's/@PAGEOFF/:lo12:/g' {} +
          
          # 2. Fix Page Size in Source (Very Important for Android 15)
          # Dobby default 4KB uses, we force 16KB
          find . -name "*" -type f -exec sed -i 's/PAGE_SIZE 4096/PAGE_SIZE 16384/g' {} + || true

      - name: Setup NDK r27c
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r27c-linux.zip
          unzip -q android-ndk-r27c-linux.zip
          echo "NDK_PATH=$(pwd)/android-ndk-r27c" >> $GITHUB_ENV

      - name: Build Arm64
        run: |
          mkdir -p out/arm64-v8a
          cmake -S . -B build64 -DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-35 -DDOBBY_GENERATE_SHARED=OFF \
          -DCMAKE_CXX_FLAGS="-Wl,-z,max-page-size=16384"
          cmake --build build64
          cp build64/libdobby.a out/arm64-v8a/

      - name: Build Armv7
        run: |
          mkdir -p out/armeabi-v7a
          cmake -S . -B build32 -DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=armeabi-v7a -DANDROID_PLATFORM=android-35 -DDOBBY_GENERATE_SHARED=OFF
          cmake --build build32
          cp build32/libdobby.a out/armeabi-v7a/

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: Dobby_Static_NDK_r27
          path: out/
          

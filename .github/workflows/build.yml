name: Build Dobby (Force Fix Assembly)

on:
  workflow_dispatch:

jobs:
  build-dobby:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Dobby Source
        uses: actions/checkout@v4
        with:
          repository: jmpews/Dobby
          submodules: recursive
          fetch-depth: 0

      - name: Patch Dobby Assembly (Fix ADRP Error)
        run: |
          echo "Patching assembly for Clang compatibility..."
          # Fix ARM64 ADRP relocations for new NDK
          sed -i 's/@PAGE//g' source/TrampolineBridge/ClosureTrampolineBridge/arm64/closure_bridge_arm64.asm
          sed -i 's/@PAGEOFF//g' source/TrampolineBridge/ClosureTrampolineBridge/arm64/closure_bridge_arm64.asm
          # Fix ARM ADR relocations for 32-bit if needed
          sed -i 's/@PAGE//g' source/TrampolineBridge/ClosureTrampolineBridge/arm/closure_bridge_arm.asm || true
          sed -i 's/@PAGEOFF//g' source/TrampolineBridge/ClosureTrampolineBridge/arm/closure_bridge_arm.asm || true

      - name: Setup NDK r25b
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r25b" >> $GITHUB_ENV

      - name: Build Arm64 (64-bit)
        run: |
          mkdir -p output/arm64-v8a
          cmake -H. -Bbuild_64 \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI="arm64-v8a" \
            -DANDROID_PLATFORM=android-24 \
            -DDOBBY_GENERATE_SHARED=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_64
          cp build_64/libdobby.a output/arm64-v8a/

      - name: Build Armv7 (32-bit)
        run: |
          mkdir -p output/armeabi-v7a
          cmake -H. -Bbuild_32 \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI="armeabi-v7a" \
            -DANDROID_PLATFORM=android-24 \
            -DDOBBY_GENERATE_SHARED=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build_32
          cp build_32/libdobby.a output/armeabi-v7a/

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: Dobby-Fixed-Static
          path: output/
          
